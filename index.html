<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Menu</title>
  <meta name="theme-color" content="#0f0f10" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="header">
    <div class="brand">
      <img id="logo" class="logo" alt="" style="display:none" />
      <h1 id="title" class="title">Menu</h1>
    </div>
    <p id="section" class="subtitle" aria-live="polite"></p>
  </header>

  <main id="content" class="content" role="main">
    <section aria-labelledby="catalogue-heading">
      <h2 id="catalogue-heading" class="visually-hidden">Catalogue</h2>
      <div id="list" class="grid" aria-live="polite"></div>
    </section>

    <section class="card" aria-labelledby="delivery-heading">
      <h2 id="delivery-heading">Infos de livraison</h2>
      <label>Nom/Prénom
        <input id="name" placeholder="Ton nom" autocomplete="name" />
      </label>
      <label>Téléphone
        <input id="phone" placeholder="+33..." inputmode="tel" autocomplete="tel" />
      </label>
      <label>Adresse complète
        <textarea id="address" rows="3" placeholder="N°, rue, code postal, ville"></textarea>
      </label>
      <label>Note (optionnel)
        <textarea id="note" rows="2" placeholder="Digicode, étage..."></textarea>
      </label>
    </section>
  </main>

  <footer class="footer" role="contentinfo">
    <div id="total" class="total">Total: 0€</div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    const listDiv = document.getElementById("list");
    let total = 0;

    async function chargerMenu() {
      try {
        const response = await fetch('https://api.github.com/repos/sproduction1313-art/stonr/contents/content/produits');
        const produits = await response.json();

        for (const fichier of produits) {
          const res = await fetch(fichier.download_url);
          const contenu = await res.text();

          // Récupérer les métadonnées
          const meta = /---([\s\S]*?)---/.exec(contenu);
          let infos = {};
          if (meta) {
            meta[1].split('\n').forEach(ligne => {
              const [cle, ...val] = ligne.split(':');
              infos[cle.trim()] = val.join(':').trim();
            });
          }

          if (infos.published === "false") continue;

          // Affichage produit
          const produitHTML = document.createElement("div");
          produitHTML.className = "card";
          produitHTML.innerHTML = `
            ${infos.image ? `<img src="${infos.image}" alt="${infos.title}" />` : ""}
            <h3>${infos.title || 'Sans titre'}</h3>
            <p>${infos.description || ''}</p>
            <p class="prix">${infos.price ? infos.price + '€' : ''}</p>
            <button class="ajout-panier">Ajouter</button>
          `;

          // Gestion ajout panier
          produitHTML.querySelector(".ajout-panier").addEventListener("click", () => {
            if (infos.price) {
              total += parseFloat(infos.price);
              document.getElementById("total").textContent = "Total: " + total.toFixed(2) + "€";
            }
          });

          listDiv.appendChild(produitHTML);
        }
      } catch (err) {
        console.error("Erreur chargement menu :", err);
        listDiv.innerHTML = "<p>Impossible de charger le menu.</p>";
      }
    }

    chargerMenu();
  </script>
</body>
</html>
